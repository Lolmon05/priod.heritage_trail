<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NP Heritage Trail</title>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --np-orange: #ff6b00;
            --np-blue: #004d99;
            --glass: rgba(0, 15, 35, 0.95);
            --glass-border: rgba(255, 255, 255, 0.2);
            --rare: #4dabf7;
            --epic: #ae3ec9;
            --legendary: #f59f00;
            --mythic: #ff0080;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Outfit', sans-serif;
            background: radial-gradient(circle at top, #002b5c 0%, #000b1a 100%);
            color: white; margin: 0; padding: 0;
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; overflow: hidden;
        }

        .app {
            width: 100%; max-width: 400px; height: 92vh; 
            display: flex; flex-direction: column;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); 
            border-radius: 30px; border: 1px solid var(--glass-border); 
            position: relative; overflow: hidden;
        }

        header { padding: 15px; text-align: center; flex-shrink: 0; z-index: 10; position: relative; }

        .audio-toggle {
            position: absolute; right: 15px; top: 15px;
            background: var(--np-orange); border: none; color: white;
            width: 35px; height: 35px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            z-index: 100; font-size: 16px;
        }

        .score-display {
            position: absolute; left: 15px; top: 15px; font-weight: 800;
            background: var(--np-orange); color: #fff;
            padding: 5px 12px; border-radius: 20px; font-size: 11px;
        }

        .coin-display {
            position: absolute; left: 15px; top: 50px; font-weight: 800;
            background: linear-gradient(135deg, #ffd700, #ffed4e); color: #000;
            padding: 5px 12px; border-radius: 20px; font-size: 11px;
            display: flex; align-items: center; gap: 5px;
        }

        .shop-btn {
            position: absolute; right: 60px; top: 15px;
            background: linear-gradient(135deg, #ffd700, #ffed4e); border: none; color: #000;
            width: 35px; height: 35px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            z-index: 100; font-size: 18px; font-weight: 800;
        }

        .crest-container {
            width: 50px; height: 50px; margin: 0 auto 5px; background: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--np-orange);
            overflow: hidden;
        }
        
        .crest-container img {
            width: 100%; height: 100%; object-fit: cover;
        }

        .screen { 
            display: none; flex-direction: column; flex: 1; 
            padding: 0 15px 15px; overflow-y: auto; align-items: center; 
        }
        .screen.active { display: flex; animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { 
            background: var(--glass); padding: 18px; border-radius: 22px; 
            border: 1px solid var(--glass-border); text-align: center; 
            width: 100%; margin-bottom: 8px; 
        }

        .topic-label { 
            font-size: 10px; font-weight: 800; color: var(--np-orange); 
            text-transform: uppercase; margin: 8px 0 4px; 
        }
        
        .char-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-bottom: 8px; }
        
        .char-card { 
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); 
            border-radius: 15px; padding: 10px 5px; cursor: pointer; transition: 0.2s; 
            display: flex; flex-direction: column; align-items: center;
            position: relative;
        }
        .char-card:hover { border-color: var(--np-orange); background: rgba(255,107,0,0.1); transform: scale(1.05); }
        .char-card:active { transform: scale(0.98); }
        .char-card span:first-child { font-size: 30px; pointer-events: none; }
        .char-card b { font-size: 12px; color: white; margin-top: 3px; pointer-events: none; }
        
        .tag { 
            font-size: 7px; padding: 2px 5px; border-radius: 4px; 
            font-weight: 800; margin-top: 5px; text-transform: uppercase;
            pointer-events: none;
        }
        .tag-walk { background: #00ff88; color: #000; }
        .tag-digi { background: #00d4ff; color: #000; }

        .lock-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            border-radius: 15px;
            cursor: not-allowed;
        }

        .char-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .quiz-question-container {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .quiz-question-container h4 {
            margin: 0 0 15px 0;
            color: var(--np-orange);
            font-size: 14px;
        }

        .quiz-option {
            background: rgba(255,255,255,0.05);
            border: 2px solid var(--glass-border);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: 0.2s;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quiz-option:hover {
            background: rgba(255,255,255,0.1);
            border-color: var(--np-orange);
        }

        .quiz-option.selected {
            background: rgba(255,107,0,0.2);
            border-color: var(--np-orange);
        }

        .quiz-option-icon {
            font-size: 20px;
        }

        .media-box { 
            width: 100%; border-radius: 12px; overflow: hidden; 
            margin-bottom: 12px; background: #000; border: 1px solid #00d4ff; 
            height: 150px; display: none; 
        }
        .media-box img, .media-box iframe { width: 100%; height: 100%; object-fit: cover; border: none; }

        .loc-box { 
            background: rgba(0, 255, 136, 0.1); border: 1px dashed #00ff88; 
            border-radius: 12px; padding: 10px; margin-bottom: 12px; 
            text-align: left; display: none; 
        }
        .loc-box b { color: #00ff88; font-size: 10px; text-transform: uppercase; display: block; }
        .loc-box p { margin: 0; font-size: 12px; color: #fff; line-height: 1.3; }

        .quote-box { 
            font-style: italic; color: #ffccaa; border-left: 3px solid var(--np-orange); 
            padding: 10px; margin: 10px 0; text-align: left; 
            background: rgba(255,255,255,0.05); border-radius: 0 12px 12px 0; 
            font-size: 12px; 
        }
        
        .btn-action { 
            background: var(--np-orange); color: white; border: none; 
            padding: 15px; border-radius: 12px; width: 100%; font-weight: 800; 
            cursor: pointer; text-transform: uppercase; font-family: 'Outfit'; 
            margin-top: 5px; font-size: 14px;
        }
        .btn-action:hover { opacity: 0.9; }

        .option-btn { 
            background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); 
            color: white; padding: 12px; border-radius: 10px; text-align: left; 
            cursor: pointer; width: 100%; margin-bottom: 8px; 
            font-family: 'Outfit'; font-size: 14px; transition: 0.2s;
        }
        .option-btn:hover:not(:disabled) { background: rgba(255,255,255,0.15); }
        .option-btn.correct { background: #00c853 !important; font-weight: 800; }
        .option-btn.wrong { background: #d32f2f !important; opacity: 0.6; }
        .option-btn:disabled { cursor: not-allowed; }

        .map-bar { display: flex; justify-content: center; gap: 10px; padding-bottom: 10px; }
        .map-bar.hidden { display: none; }
        .node { width: 8px; height: 8px; border-radius: 50%; background: #333; transition: 0.3s; }
        .node.active { background: var(--np-orange); box-shadow: 0 0 8px var(--np-orange); }
        .node.done { background: #00ff88; }

        #transition-overlay { 
            position: absolute; inset: 0; background: var(--np-blue); 
            z-index: 2000; display: none; flex-direction: column; 
            align-items: center; justify-content: center; 
        }
        #transition-overlay.active { display: flex; }
        
        .walking-container { position: relative; width: 100%; height: 60px; }
        .adventurer { 
            position: absolute; bottom: 0; left: -50px; font-size: 35px; 
            animation: walkAni 2.5s linear infinite; 
        }
        @keyframes walkAni { 0% { left: -50px; } 100% { left: 110%; } }

        input[type="text"], input[type="password"] {
            width: 100%; padding: 15px; border-radius: 10px; 
            border: 1px solid var(--glass-border); margin-bottom: 10px;
            background: rgba(255,255,255,0.1); color: white;
            font-family: 'Outfit'; font-size: 14px;
        }
        input[type="text"]::placeholder, input[type="password"]::placeholder { color: rgba(255,255,255,0.5); }
        
        .list-container {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .list-container h4 {
            margin: 0 0 12px 0;
            color: var(--np-orange);
            font-size: 14px;
            text-align: center;
        }
        
        .list-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 6px;
            font-size: 13px;
        }
        
        .list-item.current-user {
            background: rgba(255,107,0,0.15);
            border: 1px solid var(--np-orange);
        }
        
        .list-item .rank {
            width: 30px;
            font-weight: 800;
            color: var(--np-orange);
        }
        
        .list-item .medal {
            font-size: 18px;
        }
        
        .list-item .name {
            flex: 1;
            text-align: left;
            padding: 0 10px;
        }
        
        .list-item .score {
            font-weight: 800;
            color: #00ff88;
        }

        .gacha-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .gacha-box {
            background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,237,78,0.2));
            border: 2px solid #ffd700;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
        }

        .gacha-box:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255,215,0,0.5);
        }

        .gacha-box.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .gacha-cost {
            color: #ffd700;
            font-weight: 800;
            font-size: 16px;
            margin: 5px 0;
        }

        .cosmetic-item {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.2s;
        }

        .cosmetic-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }

        .cosmetic-item.rare { border-color: var(--rare); }
        .cosmetic-item.epic { border-color: var(--epic); }
        .cosmetic-item.legendary { border-color: var(--legendary); }
        .cosmetic-item.mythic { border-color: var(--mythic); box-shadow: 0 0 15px var(--mythic); }

        .rarity-badge {
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
        }

        .rarity-rare { background: var(--rare); color: #000; }
        .rarity-epic { background: var(--epic); color: #fff; }
        .rarity-legendary { background: var(--legendary); color: #000; }
        .rarity-mythic { background: var(--mythic); color: #fff; }

        .cosmetic-icon {
            font-size: 32px;
        }

        .cosmetic-info {
            flex: 1;
            text-align: left;
        }

        .cosmetic-name {
            font-weight: 800;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .gacha-result {
            text-align: center;
            padding: 20px;
            background: rgba(0,0,0,0.5);
            border-radius: 15px;
            margin: 15px 0;
            display: none;
        }

        .gacha-result.active {
            display: block;
            animation: gachaReveal 0.5s ease-out;
        }

        @keyframes gachaReveal {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }

        .gacha-result-icon {
            font-size: 64px;
            margin: 10px 0;
        }

        .character-display {
            font-size: 60px;
            margin: 15px 0;
            position: relative;
        }

        .equipped-cosmetic {
            position: absolute;
            font-size: 20px;
            transform: translate(-50%, -50%);
        }

        .equipped-cosmetic.hat { top: -15px; left: 50%; }
        .equipped-cosmetic.accessory { top: 10px; right: -10px; }
    </style>
</head>
<body>

    <audio id="bgm" loop><source src="https://www.bensound.com/bensound-music/bensound-creativeminds.mp3" type="audio/mpeg"></audio>
    <audio id="sfx-ding"><source src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3" type="audio/mpeg"></audio>

    <div id="transition-overlay">
        <h2 style="font-weight:800; margin:0;">ON THE MOVE...</h2>
        <div class="walking-container"><div id="walking-char" class="adventurer">ü¶Å</div></div>
    </div>

    <div class="app">
        <header>
            <div class="score-display" id="header-score">PTS: 0</div>
            <div class="coin-display" id="header-coins">ü™ô 0</div>
            <button class="shop-btn" id="shop-btn" title="Shop & Inventory">üõçÔ∏è</button>
            <button class="audio-toggle" id="mute-btn">üîä</button>
            <div class="crest-container">
               <img src="https://sifma.org.sg/media/ax0pg51v/np_logo_full_colour_vertical.jpg" alt="NP Logo">
            </div>
            <h1 style="margin:0; font-size: 16px; letter-spacing: 1px;">MEMORY TRAIL</h1>
        </header>

        <div class="map-bar hidden" id="map-bar">
            <div class="node" id="n0"></div>
            <div class="node" id="n1"></div>
            <div class="node" id="n2"></div>
        </div>
        <div id="screen-start" class="screen active">
            <div class="card">
                <h2 style="margin-top:0;">WELCOME</h2>
                
                <div id="login-form">
                    <input type="text" id="login-username" placeholder="Username">
                    <input type="password" id="login-password" placeholder="Password">
                    <button class="btn-action" id="login-btn">LOGIN</button>
                    <button class="btn-action" style="background:#444; margin-top:5px;" id="show-register-btn">CREATE NEW ACCOUNT</button>
                </div>
                
                <div id="register-form" style="display:none;">
                    <input type="text" id="register-username" placeholder="Choose Username">
                    <input type="password" id="register-password" placeholder="Choose Password">
                    <input type="password" id="register-confirm" placeholder="Confirm Password">
                    <button class="btn-action" id="register-btn">CREATE ACCOUNT</button>
                    <button class="btn-action" style="background:#444; margin-top:5px;" id="show-login-btn">BACK TO LOGIN</button>
                </div>
                
                <div id="login-message" style="margin-top:10px; font-size:12px; text-align:center; display:none;"></div>
            </div>
        </div>

        <div id="screen-daily" class="screen">
            <div class="card">
                <h2 style="margin:0 0 15px 0;">üìÖ DAILY DASHBOARD</h2>
                
                <div style="background:rgba(255,107,0,0.1); border:1px solid var(--np-orange); border-radius:12px; padding:15px; margin-bottom:15px;">
                    <div style="display:flex; justify-content:space-around; text-align:center;">
                        <div>
                            <div style="font-size:28px; color:var(--np-orange); font-weight:800;" id="streak-count">0</div>
                            <div style="font-size:10px; color:#999;">üî• DAY STREAK</div>
                        </div>
                        <div>
                            <div style="font-size:28px; color:#00ff88; font-weight:800;" id="total-logins">0</div>
                            <div style="font-size:10px; color:#999;">üìä TOTAL LOGINS</div>
                        </div>
                    </div>
                </div>
                
                <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:15px; margin-bottom:15px;">
                    <h4 style="margin:0 0 12px 0; color:#00d4ff; font-size:14px;">‚≠ê TODAY'S TASK</h4>
                    <div id="daily-task-content"></div>
                </div>
                
                <button class="btn-action" id="start-journey-btn">START JOURNEY</button>
            </div>
        </div>

        <div id="screen-quiz-intro" class="screen">
            <div class="card">
                <h2 style="margin:0 0 15px 0;">üîÆ DISCOVER YOUR PATH</h2>
                <p style="font-size:13px; color:#999; margin-bottom:20px;">Answer these questions to find out which trail suits you best!</p>
                <div id="personality-quiz"></div>
                <div id="quiz-result" style="display:none; margin-top:20px;">
                    <div style="background:rgba(255,107,0,0.1); border:1px solid var(--np-orange); border-radius:12px; padding:20px; text-align:center;">
                        <div id="result-icon" style="font-size:48px; margin-bottom:10px;"></div>
                        <h3 id="result-title" style="margin:10px 0; color:var(--np-orange);"></h3>
                        <p id="result-desc" style="font-size:12px; color:#ccc; margin-bottom:15px;"></p>
                        <button class="btn-action" id="start-recommended-trail">START YOUR TRAIL</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="screen-character" class="screen">
            <div class="card">
                <h3 style="margin:0 0 15px 0;">CHOOSE YOUR GUIDE</h3>
                <div id="trail-unlock-message" style="background:rgba(255,107,0,0.1); border:1px solid var(--np-orange); border-radius:12px; padding:15px; margin-bottom:15px; font-size:12px; text-align:center; display:none;">
                    <div style="font-size:24px; margin-bottom:8px;">üîí</div>
                    <p style="margin:0; color:#ffaa00;">Complete your recommended trail to unlock all trails!</p>
                </div>
                
                <div class="topic-label">1. NP History</div>
                <div class="char-grid">
                    <div class="char-card" data-char="leo" data-icon="ü¶Å" data-mode="walking" data-topic="history">
                        <span id="char-display-leo">ü¶Å</span><b>Leo</b><span class="tag tag-walk">Walking Trail</span>
                        <div class="lock-overlay" style="display:none;">üîí</div>
                    </div>
                    <div class="char-card" data-char="sage" data-icon="ü¶â" data-mode="digital" data-topic="history">
                        <span id="char-display-sage">ü¶â</span><b>Sage</b><span class="tag tag-digi">Digital Trail</span>
                        <div class="lock-overlay" style="display:none;">üîí</div>
                    </div>
                </div>

                <div class="topic-label">2. NP Founders</div>
                <div class="char-grid">
                    <div class="char-card" data-char="ollie" data-icon="ü¶¶" data-mode="walking" data-topic="founders">
                        <span id="char-display-ollie">ü¶¶</span><b>Ollie</b><span class="tag tag-walk">Walking Trail</span>
                        <div class="lock-overlay" style="display:none;">üîí</div>
                    </div>
                    <div class="char-card" data-char="felix" data-icon="üê±" data-mode="digital" data-topic="founders">
                        <span id="char-display-felix">üê±</span><b>Felix</b><span class="tag tag-digi">Digital Trail</span>
                        <div class="lock-overlay" style="display:none;">üîí</div>
                    </div>
                </div>

                <div class="topic-label">3. Famous Alumni</div>
                <div class="char-grid">
                    <div class="char-card" data-char="momo" data-icon="üêí" data-mode="walking" data-topic="alumni">
                        <span id="char-display-momo">üêí</span><b>Momo</b><span class="tag tag-walk">Walking Trail</span>
                        <div class="lock-overlay" style="display:none;">üîí</div>
                    </div>
                    <div class="char-card" data-char="sparky" data-icon="üêøÔ∏è" data-mode="digital" data-topic="alumni">
                        <span id="char-display-sparky">üêøÔ∏è</span><b>Sparky</b><span class="tag tag-digi">Digital Trail</span>
                        <div class="lock-overlay" style="display:none;">üîí</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="screen-clue" class="screen">
            <div class="card">
                <h3 id="clue-title" style="color:var(--np-orange); margin:0 0 10px 0; font-size:16px;"></h3>
                <div id="clue-media" class="media-box"></div>
                <div id="location-hint" class="loc-box">
                    <b>üìç Location Clue</b>
                    <p id="location-text"></p>
                </div>
                <div id="clue-quote" class="quote-box"></div>
                <button class="btn-action" id="ready-btn">I'M READY!</button>
            </div>
        </div>

        <div id="screen-quiz" class="screen">
            <div class="card">
                <div id="attempts-display" style="color:#ffaa00; font-weight:800; margin-bottom:10px; font-size:12px;"></div>
                <p id="quiz-question" style="font-weight: 600; margin:0 0 15px 0; font-size:14px;"></p>
                <div id="quiz-options"></div>
            </div>
        </div>

        <div id="screen-shop" class="screen">
            <div class="card">
                <h2 style="margin:0 0 15px 0;">üõçÔ∏è SHOP & INVENTORY</h2>
                
                <div style="background:rgba(255,215,0,0.1); border:1px solid #ffd700; border-radius:12px; padding:15px; margin-bottom:15px; text-align:center;">
                    <div style="font-size:24px; color:#ffd700; font-weight:800;" id="shop-coins-display">ü™ô 0</div>
                    <div style="font-size:11px; color:#999; margin-top:5px;">Your Coins</div>
                </div>

                <h3 style="margin:15px 0 10px 0; font-size:14px; color:var(--np-orange);">üé∞ GACHA SYSTEM</h3>
                <div class="gacha-container">
                    <div class="gacha-box" id="gacha-normal" data-cost="100">
                        <div style="font-size:32px;">üì¶</div>
                        <div style="font-weight:800; margin:5px 0;">Normal Gacha</div>
                        <div class="gacha-cost">ü™ô 100</div>
                        <div style="font-size:10px; color:#999;">Common - Epic</div>
                    </div>
                    <div class="gacha-box" id="gacha-premium" data-cost="300">
                        <div style="font-size:32px;">üíé</div>
                        <div style="font-weight:800; margin:5px 0;">Premium Gacha</div>
                        <div class="gacha-cost">ü™ô 300</div>
                        <div style="font-size:10px; color:#999;">Epic - Mythic</div>
                    </div>
                </div>

                <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:15px; margin:15px 0;">
                    <h4 style="margin:0 0 10px 0; font-size:13px; color:#00d4ff; text-align:center;">üìã AVAILABLE COSMETICS</h4>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <button id="preview-hats-btn" class="btn-action" style="padding:8px; font-size:11px; flex:1; background:#444;">View Hats</button>
                        <button id="preview-accessories-btn" class="btn-action" style="padding:8px; font-size:11px; flex:1; background:#444;">View Accessories</button>
                    </div>
                    <div id="cosmetic-preview-list" style="max-height:200px; overflow-y:auto;"></div>
                </div>

                <div id="gacha-result" class="gacha-result">
                    <div id="gacha-result-icon" class="gacha-result-icon"></div>
                    <div id="gacha-result-name" style="font-weight:800; font-size:18px; margin:10px 0;"></div>
                    <div id="gacha-result-rarity" style="margin:10px 0;"></div>
                </div>

                <h3 style="margin:20px 0 10px 0; font-size:14px; color:var(--np-orange);">üé® YOUR COSMETICS</h3>
                <div id="cosmetics-list" style="max-height:300px; overflow-y:auto;"></div>

                <div style="margin-top:20px; padding-top:15px; border-top:1px solid var(--glass-border);">
                    <h3 style="margin:0 0 10px 0; font-size:14px; color:var(--np-orange);">üë§ CHARACTER CUSTOMIZATION</h3>
                    <div class="character-display" id="character-preview"></div>
                    <div id="equipped-cosmetics" style="font-size:12px; color:#999; margin-top:10px;"></div>
                </div>

                <button class="btn-action" style="background:#444; margin-top:15px;" id="back-from-shop-btn">BACK</button>
            </div>
        </div>

        <div id="screen-finish" class="screen">
            <div class="card">
                <h2 style="margin:0 0 15px 0;">üéâ JOURNEY COMPLETE!</h2>
                <div style="text-align:left; background:rgba(0,0,0,0.3); padding:15px; border-radius:12px; font-size:12px; margin: 10px 0;">
                    <p style="margin:5px 0;">Walking Trail: <b id="res-walking" style="color:#00ff88">0</b> pts</p>
                    <p style="margin:5px 0;">Digital Trail: <b id="res-digital" style="color:#00d4ff">0</b> pts</p>
                    <p style="margin:5px 0;">Daily Tasks: <b id="res-daily" style="color:#ffaa00">0</b> pts</p>
                    <p style="font-weight:800; border-top:1px solid #444; margin-top:10px; padding-top:10px; margin-bottom:0;">
                        Total Score: <b id="res-total" style="color:var(--np-orange)">0 pts</b>
                    </p>
                </div>
                
                <div style="background:rgba(255,107,0,0.1); border:1px solid var(--np-orange); border-radius:12px; padding:15px; margin:15px 0; text-align:left;">
                    <h4 style="margin:0 0 10px 0; color:var(--np-orange); font-size:13px;">üí° The next chapter belongs to you. What will it be?</h4>
                    <textarea 
                        id="feedback-text" 
                        placeholder="Share your vision for NP's future, your experience today, or ideas to make this better..."
                        style="width:100%; min-height:80px; padding:10px; border-radius:8px; border:1px solid var(--glass-border); background:rgba(0,0,0,0.3); color:white; font-family:'Outfit'; font-size:12px; resize:vertical;"
                    ></textarea>
                    
                    <button class="btn-action" style="padding:10px; font-size:12px; margin-top:8px;" id="submit-feedback-btn">SUBMIT FEEDBACK</button>
                    <div id="feedback-status" style="margin-top:8px; font-size:11px; text-align:center; display:none;"></div>
                </div>
                
                <button class="btn-action" style="background:#444; padding:10px; font-size:12px; margin-bottom:10px;" id="view-feedback-btn">üåü VIEW COMMUNITY WALL</button>

                <div class="list-container" id="leaderboard-container">
                    <h4>üèÜ Leaderboard - Top 10</h4>
                    <div id="leaderboard-list"></div>
                </div>
                
                <button id="switch-btn" class="btn-action"></button>
                <button class="btn-action" style="background:#333; margin-top:5px;" id="restart-btn">START NEW JOURNEY</button>
            </div>
        </div>

        <div id="screen-feedback" class="screen">
            <div class="card">
                <h2 style="margin:0 0 15px 0;">üåü Community Wall</h2>
                <div id="feedback-list"></div>
                <button class="btn-action" style="background:#444; margin-top:15px;" id="back-to-finish">BACK TO RESULTS</button>
            </div>
        </div>
    </div>

    <script>
        const state = {
            userName: "",
            currentMode: "",
            currentChar: "",
            currentStage: 0,
            attemptsLeft: 3,
            isMuted: false,
            quizAnswered: false,
            dailyTaskCompleted: false,
            accountData: null,
            recommendedMode: "",
            quizAnswers: []
        };

        const audio = {
            bgm: document.getElementById('bgm'),
            sfx: document.getElementById('sfx-ding')
        };

        // Cosmetic items database
        const cosmeticDatabase = {
            hats: [
                { id: 'crown_rare', name: 'Golden Crown', icon: 'üëë', rarity: 'rare', type: 'hat', forChar: 'all' },
                { id: 'cap_rare', name: 'Adventure Cap', icon: 'üß¢', rarity: 'rare', type: 'hat', forChar: 'all' },
                { id: 'hat_epic', name: 'Mystic Hat', icon: 'üé©', rarity: 'epic', type: 'hat', forChar: 'all' },
                { id: 'cap_epic', name: 'Hero Cap', icon: '‚õëÔ∏è', rarity: 'epic', type: 'hat', forChar: 'all' },
                { id: 'crown_legendary', name: 'Royal Crown', icon: 'üëë', rarity: 'legendary', type: 'hat', forChar: 'all' },
                { id: 'halo_legendary', name: 'Divine Halo', icon: 'üòá', rarity: 'legendary', type: 'hat', forChar: 'all' },
                { id: 'crown_mythic', name: 'Legendary Crown', icon: 'üëë', rarity: 'mythic', type: 'hat', forChar: 'all' },
                { id: 'star_mythic', name: 'Stellar Aura', icon: '‚≠ê', rarity: 'mythic', type: 'hat', forChar: 'all' }
            ],
            accessories: [
                { id: 'glasses_rare', name: 'Cool Shades', icon: 'üï∂Ô∏è', rarity: 'rare', type: 'accessory', forChar: 'all' },
                { id: 'tie_rare', name: 'Classy Tie', icon: 'üëî', rarity: 'rare', type: 'accessory', forChar: 'all' },
                { id: 'glasses_epic', name: 'Smart Glasses', icon: 'ü§ì', rarity: 'epic', type: 'accessory', forChar: 'all' },
                { id: 'badge_epic', name: 'Honor Badge', icon: 'üéñÔ∏è', rarity: 'epic', type: 'accessory', forChar: 'all' },
                { id: 'medal_legendary', name: 'Champion Medal', icon: 'üèÖ', rarity: 'legendary', type: 'accessory', forChar: 'all' },
                { id: 'crystal_legendary', name: 'Power Crystal', icon: 'üíé', rarity: 'legendary', type: 'accessory', forChar: 'all' },
                { id: 'orb_mythic', name: 'Mystic Orb', icon: 'üîÆ', rarity: 'mythic', type: 'accessory', forChar: 'all' },
                { id: 'flame_mythic', name: 'Eternal Flame', icon: 'üî•', rarity: 'mythic', type: 'accessory', forChar: 'all' }
            ]
        };

        // Gacha probabilities
        const gachaRates = {
            normal: { rare: 50, epic: 30, legendary: 18, mythic: 2 },
            premium: { rare: 0, epic: 40, legendary: 45, mythic: 15 }
        };

        // Personality Quiz
        const personalityQuiz = [
            {
                question: "How do you prefer to learn about new things?",
                options: [
                    { text: "By doing hands-on activities and exploring", icon: "üö∂", value: "walking" },
                    { text: "By watching videos and reading online", icon: "üíª", value: "digital" }
                ]
            },
            {
                question: "When visiting a museum, you would rather:",
                options: [
                    { text: "Walk around and discover exhibits yourself", icon: "üó∫Ô∏è", value: "walking" },
                    { text: "Use an audio guide or app for information", icon: "üì±", value: "digital" }
                ]
            },
            {
                question: "Your ideal weekend activity is:",
                options: [
                    { text: "Going on an outdoor adventure or heritage trail", icon: "üèÉ", value: "walking" },
                    { text: "Exploring documentaries or virtual tours", icon: "üé¨", value: "digital" }
                ]
            },
            {
                question: "How do you remember information best?",
                options: [
                    { text: "By physically being there and experiencing it", icon: "üëÄ", value: "walking" },
                    { text: "By seeing visuals, videos, and multimedia", icon: "üì∫", value: "digital" }
                ]
            },
            {
                question: "When learning about history, you prefer:",
                options: [
                    { text: "Visiting actual historical locations", icon: "üèõÔ∏è", value: "walking" },
                    { text: "Interactive digital content and videos", icon: "üñ•Ô∏è", value: "digital" }
                ]
            }
        ];

        const storyData = {
            leo: [
                { title: "NP History - Stage 1",
                 question: "Where did classes first begin?",
                 image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTJTDSEgbt9QrEv7qi8ryFDNDvKTA36vPzdMw&s",  
                 options: ["Tank Road", "Clementi Road", "Orchard", "Jurong"],
                 answer: "Tank Road", 
                 exp: "Leo", 
                 icon: "ü¶Å", 
                 fact: "Hi, I'm Leo the Lion! ü¶Å Let's explore NP's history. See this massive campus? In 1963, we weren't here at Clementi Road we started at Tank Road! Want to see how it looked? Complete the puzzle to reveal our origins.", 
                 loc: "Find the touchscreen to the right of staircase on level 5!"},

                { title: "NP History - Stage 2",
                 question: "When did NP move to Clementi campus?", 
                 image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS_tZDZ1SGb0yyvIx1TmaBSu84YXNQJhJjH0Q&s", 
                 options: ["1998", "2000", "2005", "1995"], 
                 answer: "1998", 
                 exp: "Leo",
                  icon: "ü¶Å", 
                  fact: "By the end of the 1990s, NP entered a new phase of growth with a shift to a larger, purpose-built environment.", 
                  loc: "Visit the Campus Model at Block 1 Level 1 to see the layout!"},

                { title: "NP History - Stage 3",
                 question: "What does NP stand for?", 
                 image: "https://www.np.edu.sg/images/default-source/about-np-2/about-np.jpg?sfvrsn=81d77414_5", 
                 options: ["Ngee Ann Polytechnic", "National Polytechnic", "New Polytechnic", "North Polytechnic"], 
                 answer: "Ngee Ann Polytechnic", 
                 exp: "Leo", 
                 icon: "ü¶Å", 
                 fact: "The name Ngee Ann carries a Teochew meaning that embodies moral excellence and strong values.", 
                 loc: "Check out the Heritage Corner at Block 83 to learn more about our name!" }
            ],
            sage: [
                { title: "NP History - Stage 1", 
                question: "Where did classes first begin?", 
                 image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTJTDSEgbt9QrEv7qi8ryFDNDvKTA36vPzdMw&s", 
                 options: ["Tank Road", "Clementi Road", "Orchard", "Jurong"], 
                 answer: "Tank Road", 
                 exp: "Sage",
                  icon: "ü¶â", 
                  fact: "Early records point to a modest starting place along a historic road where NP first took root.", 
                  media: '<iframe width="560" height="315" src="https://www.youtube.com/embed/2e_3UKU1esw?si=pMLhvoqXtMgKV57D" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>' },
               
                  { title: "NP History - Stage 2",
                 question: "When did NP move to Clementi campus?",  
                 image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS_tZDZ1SGb0yyvIx1TmaBSu84YXNQJhJjH0Q&s", 
                 options: ["1998", "2000", "2005", "1995"], 
                 answer: "1998", exp: "Sage", 
                 icon: "ü¶â", 
                 fact: "A significant relocation in the late 1990s signaled the beginning of a transformative chapter for NP.", 
                },
              
                 { title: "NP History - Stage 3", 
                question: "What does 'Ngee Ann' mean?",  
                image: "https://www.np.edu.sg/images/default-source/about-np-2/about-np.jpg?sfvrsn=81d77414_5", 
                options: ["Best of Righteousness", "New Achievement", "Great Learning", "Noble Ambition"],
                 answer: "Best of Righteousness", 
                 exp: "Sage", 
                 icon: "ü¶â", 
                 fact: "The name Ngee Ann comes from Teochew roots and carries ideals tied to strong moral character.", 
                  }
            ],
            ollie: [
                { title: "NP Founders - Stage 1", 
                question: "Who founded Ngee Ann Polytechnic?",  
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ4zMSeI-80HdliQ4a2bmh4ADErDgNohcmq0g&s",
                 options: ["Ngee Ann Kongsi", "Government", "Teachers Association", "British Council"],
                  answer: "Ngee Ann Kongsi",
                   exp: "Ollie", 
                   icon: "ü¶¶", 
                   fact: "NP was established in the early 1960s by a community organisation rooted in Teochew heritage, with a strong focus on education and culture.", 
                   loc: "Visit the Library Level 4 touchscreen near the window!" },

                { title: "NP Founders - Stage 2",
                 question: "What community does Ngee Ann Kongsi represent?",  
                image: "https://seaheuchin.info/Teochew_Building_Mar_06.JPG", 
                options: ["Teochew", "Hokkien", "Cantonese", "Hakka"], 
                answer: "Teochew", 
                exp: "Ollie", 
                icon: "ü¶¶", 
                fact: "This long-standing organisation has supported education for well over a century.",
                 loc: "Explore the Teochew Heritage exhibit at Block 1 Level 2!" },

                { title: "NP Founders - Stage 3", 
                question: "What was the main goal of founding NP?",
                 image: "https://media.licdn.com/dms/image/v2/D4E12AQFQpJ-T7l_uxQ/article-cover_image-shrink_600_2000/article-cover_image-shrink_600_2000/0/1713972138640?e=2147483647&v=beta&t=K7maKwlmD8oEPO_YVcf-_XCy1AvnX7t66Zp8-9jYmME",  
                 options: ["Quality education for all", "Make money", "Build buildings", "Create jobs"],
                  answer: "Quality education for all",
                   exp: "Ollie", 
                   icon: "ü¶¶", 
                   fact: "NP's beginnings were guided by a vision to open pathways of practical learning for young people.",
                    loc: "Read the Mission Statement plaque at the Main Entrance!" }
            ],
            felix: [
                { title: "NP Founders - Stage 1",
                 question: "What year was Ngee Ann Polytechnic founded?", 
                 image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ4zMSeI-80HdliQ4a2bmh4ADErDgNohcmq0g&s", 
                  options: ["1963", "1965", "1960", "1970"], 
                  answer: "1963",
                   exp: "Felix", 
                   icon: "üê±", 
                   fact: "In the early 1960s, NP was set up by a heritage organisation with deep Teochew roots, guided by a belief in education and cultural continuity.",
                    media: '<iframe width="560" height="315" src="https://www.youtube.com/embed/2e_3UKU1esw?si=pMLhvoqXtMgKV57D" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>' },
               
                    { title: "NP Founders - Stage 2",
                 question: "When was Ngee Ann Kongsi established?",  
                 image: "https://upload.wikimedia.org/wikipedia/commons/thumb/8/88/Ngee_Ann_City_%282023-06-05%29_IMG_01.jpg/640px-Ngee_Ann_City_%282023-06-05%29_IMG_01.jpg", 
                 options: ["1845", "1900", "1920", "1800"], 
                 answer: "1845", 
                 exp: "Felix", 
                 icon: "üê±", 
                 fact: "Its establishment dates back to the 1800s, placing it among the earliest community organisations in the nation.",
                   },
             
                  { title: "NP Founders - Stage 3", 
                question: "How many polytechnics were there when NP was founded?", 
                 image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTJTDSEgbt9QrEv7qi8ryFDNDvKTA36vPzdMw&s",
                  options: ["2", "1", "3", "5"], 
                  answer: "2", 
                  exp: "Felix",
                  icon: "üê±", 
                  fact: "Following the establishment of the nation's first polytechnic, NP opened its doors as the second of its kind.",
                   }
            ],
            momo: [
                { title: "Famous Alumni - Stage 1",
                 question: "Who is a famous film director from NP?", 
                  image: "https://variety.com/wp-content/uploads/2014/01/chen.jpg?w=1000&h=667&crop=1", 
                  options: ["Anthony Chen", "Jack Neo", "Christopher Nolan", "Jack Cheng"], 
                  answer: "Anthony Chen", 
                  exp: "Momo", 
                  icon: "üêí", 
                  fact: "An NP alumnus from the Film, Sound & Video programme made waves internationally, winning a top award at Cannes in 2013 for his debut feature.", 
                  loc: "Check out the Alumni Success Wall at Level 3 to see more inspiring NP graduates!" },

                { title: "Famous Alumni - Stage 2", 
                question: "Which NP school did Anthony Chen graduate from?",  
                image: "https://www.np.edu.sg/images/default-source/schools-courses/school-of-film-media-studies/usp1.jpg?sfvrsn=607d62d6_8", 
                options: ["Film & Media Studies", "Business", "Engineering", "Design"], 
                answer: "Film & Media Studies", 
                exp: "Momo",
                 icon: "üêí", 
                 fact: "From campus to cameras, this school has helped launch award-winning careers in film and media.",
                 loc: "Visit the Media Studios at Block 51 to see where the magic happens!" },

                { title: "Famous Alumni - Stage 3", 
                question: "NP alumni work in diverse fields including:", 
                image: "https://www.naa.edu.sg/wp-content/uploads/2024/10/alumni-img.jpg",  
                options: ["All industries", "Only tech", "Only media", "Only business"], 
                answer: "All industries", 
                exp: "Momo", 
                icon: "üêí", 
                fact: "From innovation to the arts, NP alumni are making waves across multiple sectors.",
                 loc: "Browse the Alumni Achievement Gallery at Block 1 Level 3!" }
            ],
            sparky: [
                { 
                 title: "Famous Alumni - Stage 1", 
                 question: "Which award did Anthony Chen win at Cannes?",  
                 image: "https://cdn.i-scmp.com/sites/default/files/styles/1020x680/public/2013/11/15/cbed19ad66bf7ebac2dbf57f3dc633d8.jpg?itok=Azo7dCuy",
                 options: ["Camera d'Or", "Palme d'Or", "Best Director", "Grand Prix"], 
                 answer: "Camera d'Or", 
                 exp: "Sparky", 
                 icon: "üêøÔ∏è", 
                 fact: "An NP Film graduate gained international acclaim at Cannes with a historic win.", 
                 media: '<iframe width="560" height="315" src="https://www.youtube.com/embed/P5m4GFLZDaA?si=5B0p6AtljR5LzNBK" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>' 
                },
                { title: "Famous Alumni - Stage 2", 
                question: "What is the title of Anthony Chen's award-winning film?", 
                image: "https://resizing.flixster.com/-XZAfHZM39UwaGJIFWKAE8fS0ak=/v3/t/assets/p10004403_p_v10_ac.jpg", 
                 options: ["Ilo Ilo", "Wonder Boy", "Wet Season", "Singapore Dreaming"], 
                 answer: "Ilo Ilo", 
                 exp: "Sparky", 
                 icon: "üêøÔ∏è",
                fact: "This debut film explores the bond between a household helper and a local family during a major 1990s financial crisis."},
                { title: "Famous Alumni - Stage 3", 
                question: "What year did Anthony Chen win at Cannes?", 
                 image: "https://weekender.com.sg/wp-content/uploads/2013/09/48-Be-Happier-4-e1380275997452.jpg", 
                 options: ["2013", "2010", "2015", "2012"], 
                 answer: "2013", 
                 exp: "Sparky", 
                 icon: "üêøÔ∏è", 
                 fact: "The Cannes achievement marked a milestone for Singapore cinema and fueled inspiration among budding directors.", }
            ]
        };

        const storage = {
            getUserKey: () => `np_u_${state.userName.toLowerCase()}`,
            getUserData: () => {
                try {
                    const data = localStorage.getItem(storage.getUserKey());
                    return data ? JSON.parse(data) : {};
                } catch (e) {
                    console.error('Error reading user data:', e);
                    return {};
                }
            },
            saveUserData: (data) => {
                try {
                    localStorage.setItem(storage.getUserKey(), JSON.stringify(data));
                    return true;
                } catch (e) {
                    console.error('Error saving user data:', e);
                    return false;
                }
            },
            createAccount: (username, password) => {
                const accountKey = `np_account_${username.toLowerCase()}`;
                if (localStorage.getItem(accountKey)) return false;
                const accountData = {
                    username: username,
                    password: password,
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    streak: 0,
                    lastTaskDate: null,
                    totalLogins: 1
                };
                localStorage.setItem(accountKey, JSON.stringify(accountData));
                return true;
            },
            validateLogin: (username, password) => {
                const accountKey = `np_account_${username.toLowerCase()}`;
                const data = localStorage.getItem(accountKey);
                if (!data) return false;
                const account = JSON.parse(data);
                if (account.password !== password) return false;
                
                const today = new Date().toDateString();
                const lastLogin = account.lastLogin ? new Date(account.lastLogin).toDateString() : null;
                
                if (lastLogin !== today) {
                    account.totalLogins = (account.totalLogins || 0) + 1;
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    if (lastLogin === yesterday.toDateString()) {
                        account.streak = (account.streak || 0) + 1;
                    } else if (lastLogin !== today) {
                        account.streak = 1;
                    }
                    account.lastLogin = new Date().toISOString();
                    localStorage.setItem(accountKey, JSON.stringify(account));
                }
                return account;
            },
            getAccountData: (username) => {
                const accountKey = `np_account_${username.toLowerCase()}`;
                const data = localStorage.getItem(accountKey);
                return data ? JSON.parse(data) : null;
            },
           getCoins: () => {
                const data = storage.getUserData();
                if (data.coins === undefined) {
                    data.coins = 500;
                    storage.saveUserData(data);
                }
                return data.coins || 500;
            },
            addCoins: (amount) => {
                const data = storage.getUserData();
                data.coins = (data.coins || 0) + amount;
                storage.saveUserData(data);
                updateCoinDisplay();
                return data.coins;
            },
            spendCoins: (amount) => {
                const data = storage.getUserData();
                const currentCoins = data.coins || 0;
                if (currentCoins < amount) return false;
                data.coins = currentCoins - amount;
                storage.saveUserData(data);
                updateCoinDisplay();
                return true;
            },
            getCosmetics: () => {
                const data = storage.getUserData();
                return data.cosmetics || [];
            },
            addCosmetic: (cosmetic) => {
                const data = storage.getUserData();
                if (!data.cosmetics) data.cosmetics = [];
                if (!data.cosmetics.find(c => c.id === cosmetic.id)) {
                    data.cosmetics.push(cosmetic);
                    storage.saveUserData(data);
                    return true;
                }
                return false;
            },
            getEquippedCosmetics: () => {
                const data = storage.getUserData();
                return data.equippedCosmetics || {};
            },
            equipCosmetic: (cosmeticId, slot) => {
                const data = storage.getUserData();
                if (!data.equippedCosmetics) data.equippedCosmetics = {};
                data.equippedCosmetics[slot] = cosmeticId;
                storage.saveUserData(data);
            },
            unequipCosmetic: (slot) => {
                const data = storage.getUserData();
                if (!data.equippedCosmetics) data.equippedCosmetics = {};
                delete data.equippedCosmetics[slot];
                storage.saveUserData(data);
            },
            saveScore: (points) => {
                const data = storage.getUserData();
                const charKey = state.currentChar;
                if (!data[charKey]) data[charKey] = {};
                const currentScore = data[charKey][state.currentStage] || 0;
                if (points > currentScore) {
                    data[charKey][state.currentStage] = points;
                    const coinsEarned = Math.floor(points / 10);
                    if (coinsEarned > 0) {
                        data.coins = (data.coins || 0) + coinsEarned;
                    }
                    storage.saveUserData(data);
                    updateCoinDisplay();
                }
            },
            getTotalScore: () => {
                const data = storage.getUserData();
                let total = 0;
                Object.keys(data).forEach(charKey => {
                    if (typeof data[charKey] === 'object' && charKey !== 'dailyTaskBonus' && charKey !== 'cosmetics' && charKey !== 'equippedCosmetics') {
                        Object.values(data[charKey]).forEach(score => total += score);
                    }
                });
                return { total };
            },
            getDailyTask: () => {
                const today = new Date().toDateString();
                const account = storage.getAccountData(state.userName);
                if (!account) return null;
                
                const tasks = [
                    { id: 'trivia1', type: 'trivia', question: 'What year was NP founded?', options: ['1963', '1965', '1960', '1970'], answer: '1963', reward: 50 },
                    { id: 'trivia2', type: 'trivia', question: 'Where was NP first located?', options: ['Tank Road', 'Clementi', 'Orchard', 'Jurong'], answer: 'Tank Road', reward: 50 },
                    { id: 'trivia3', type: 'trivia', question: 'What does "Ngee Ann" mean?', options: ['Best of Righteousness', 'New Achievement', 'Great Learning', 'Noble Ambition'], answer: 'Best of Righteousness', reward: 50 },
                    { id: 'trivia4', type: 'trivia', question: 'Who founded NP?', options: ['Ngee Ann Kongsi', 'Government', 'Teachers', 'British'], answer: 'Ngee Ann Kongsi', reward: 50 },
                    { id: 'trivia5', type: 'trivia', question: 'Which award did Anthony Chen win?', options: ['Camera d\'Or', 'Palme d\'Or', 'Best Director', 'Grand Prix'], answer: 'Camera d\'Or', reward: 50 }
                ];
                
                const dayIndex = Math.floor((new Date() - new Date('2026-01-01')) / (1000 * 60 * 60 * 24));
                return tasks[dayIndex % tasks.length];
            },
            completeDailyTask: (taskId) => {
                const account = storage.getAccountData(state.userName);
                if (!account) return false;
                const today = new Date().toDateString();
                if (account.lastTaskDate === today) return false;
                
                account.lastTaskDate = today;
                const accountKey = `np_account_${state.userName.toLowerCase()}`;
                localStorage.setItem(accountKey, JSON.stringify(account));
                return true;
            },
            getAllUsers: () => {
                const users = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('np_u_')) {
                        try {
                            const userName = key.replace('np_u_', '');
                            const data = JSON.parse(localStorage.getItem(key));
                            let total = 0;
                            Object.keys(data).forEach(charKey => {
                                if (typeof data[charKey] === 'object' && charKey !== 'dailyTaskBonus' && charKey !== 'cosmetics' && charKey !== 'equippedCosmetics') {
                                    Object.values(data[charKey]).forEach(score => total += score);
                                }
                            });
                            total += (data.dailyTaskBonus || 0);
                            users.push({ name: userName, total: total });
                        } catch (e) {
                            console.error('Error parsing user data:', e);
                        }
                    }
                }
                return users.sort((a, b) => b.total - a.total);
            },
            hasCompletedRecommendedTrail: () => {
                const data = storage.getUserData();
                if (!data.recommendedMode) return true;
                
                const recommendedChars = data.recommendedMode === 'walking' 
                    ? ['leo', 'ollie', 'momo'] 
                    : ['sage', 'felix', 'sparky'];
                
                for (let char of recommendedChars) {
                    if (data[char] && Object.keys(data[char]).length === 3) {
                        return true;
                    }
                }
                return false;
            },
            setRecommendedMode: (mode) => {
                const data = storage.getUserData();
                data.recommendedMode = mode;
                storage.saveUserData(data);
            },
            getRecommendedMode: () => {
                const data = storage.getUserData();
                return data.recommendedMode || null;
            }
        };

        function navigate(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const target = document.getElementById(screenId);
            if (target) target.classList.add('active');
        }

      function toggleMute() {
    state.isMuted = !state.isMuted;
    audio.bgm.muted = state.isMuted;
    document.getElementById('mute-btn').innerText = state.isMuted ? "üîá" : "üîä";
}

function updateCoinDisplay() {
    const coins = storage.getCoins();
    document.getElementById('header-coins').innerText = `ü™ô ${coins}`;
    const shopCoins = document.getElementById('shop-coins-display');
    if (shopCoins) shopCoins.innerText = `ü™ô ${coins}`;
    
    const normalGacha = document.getElementById('gacha-normal');
    const premiumGacha = document.getElementById('gacha-premium');
    
    if (normalGacha && coins < 100) {
        normalGacha.classList.add('disabled');
    } else if (normalGacha) {
        normalGacha.classList.remove('disabled');
    }
    
    if (premiumGacha && coins < 300) {
        premiumGacha.classList.add('disabled');
    } else if (premiumGacha) {
        premiumGacha.classList.remove('disabled');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('mute-btn').addEventListener('click', toggleMute);
    document.getElementById('login-btn').addEventListener('click', handleLogin);
    document.getElementById('register-btn').addEventListener('click', handleRegister);
    document.getElementById('show-register-btn').addEventListener('click', showRegisterForm);
    document.getElementById('show-login-btn').addEventListener('click', showLoginForm);
    document.getElementById('start-journey-btn').addEventListener('click', enterApp);
    document.getElementById('start-recommended-trail').addEventListener('click', () => {
        updateCharacterLocks();
        navigate('screen-character');
    });
    document.getElementById('ready-btn').addEventListener('click', showQuiz);
    document.getElementById('restart-btn').addEventListener('click', () => {
        state.currentStage = 0;
        state.currentMode = '';
        state.currentChar = '';
        updateCharacterLocks();
        navigate('screen-character');
    });
    document.getElementById('switch-btn').addEventListener('click', startOppositeMode);
    document.getElementById('shop-btn').addEventListener('click', () => {
        updateCoinDisplay();
        updateCosmeticsList();
        updateCharacterPreview();
        navigate('screen-shop');
    });
    document.getElementById('back-from-shop-btn').addEventListener('click', () => {
        navigate('screen-finish');
    });
    document.getElementById('gacha-normal').addEventListener('click', () => rollGacha('normal'));
    document.getElementById('gacha-premium').addEventListener('click', () => rollGacha('premium'));
    document.getElementById('preview-hats-btn').addEventListener('click', () => showCosmeticPreview('hats'));
    document.getElementById('preview-accessories-btn').addEventListener('click', () => showCosmeticPreview('accessories'));
    document.getElementById('submit-feedback-btn').addEventListener('click', submitFeedback);
    document.getElementById('view-feedback-btn').addEventListener('click', viewFeedback);
    document.getElementById('back-to-finish').addEventListener('click', () => navigate('screen-finish'));

    document.querySelectorAll('.char-card').forEach(card => {
        card.addEventListener('click', () => {
            if (card.classList.contains('locked')) return;
            const char = card.dataset.char;
            const icon = card.dataset.icon;
            const mode = card.dataset.mode;
            selectChar(char, icon, mode);
        });
    });

    // Login inputs - Enter key support
    document.getElementById('login-username').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleLogin();
    });
    document.getElementById('login-password').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleLogin();
    });
    document.getElementById('register-username').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleRegister();
    });
    document.getElementById('register-password').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleRegister();
    });
    document.getElementById('register-confirm').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleRegister();
    });

    // Initialize
    updateCoinDisplay();
});

// ALL FUNCTIONS BELOW ARE OUTSIDE DOMContentLoaded
function rollGacha(type) {
        const cost = parseInt(document.getElementById(`gacha-${type}`).dataset.cost);
        const coins = storage.getCoins();
        
        if (coins < cost) {
            alert(`Not enough coins! You need ${cost} coins.`);
            return;
        }

        if (!storage.spendCoins(cost)) return;

        const rates = gachaRates[type];
        const roll = Math.random() * 100;
        let rarity = 'rare';
        
        if (type === 'normal') {
            if (roll <= rates.mythic) rarity = 'mythic';
            else if (roll <= rates.mythic + rates.legendary) rarity = 'legendary';
            else if (roll <= rates.mythic + rates.legendary + rates.epic) rarity = 'epic';
            else rarity = 'rare';
        } else {
            if (roll <= rates.mythic) rarity = 'mythic';
            else if (roll <= rates.mythic + rates.legendary) rarity = 'legendary';
            else rarity = 'epic';
        }

        const allItems = [...cosmeticDatabase.hats, ...cosmeticDatabase.accessories];
        const itemsOfRarity = allItems.filter(item => item.rarity === rarity);
        const randomItem = itemsOfRarity[Math.floor(Math.random() * itemsOfRarity.length)];

        const isNew = storage.addCosmetic(randomItem);
        
        showGachaResult(randomItem, isNew);
        
        if (document.getElementById('screen-shop').classList.contains('active')) {
            updateCosmeticsList();
        }

        if (!state.isMuted) audio.sfx.play().catch(e => console.log('SFX play failed:', e));
        
        const confettiColors = {
            rare: ['#4dabf7'],
            epic: ['#ae3ec9'],
            legendary: ['#f59f00', '#ffd700'],
            mythic: ['#ff0080', '#ff1493', '#ff69b4']
        };
        confetti({ 
            particleCount: rarity === 'mythic' ? 200 : rarity === 'legendary' ? 150 : 100, 
            spread: 70, 
            origin: { y: 0.6 },
            colors: confettiColors[rarity]
        });
    }

    function showGachaResult(item, isNew) {
        const resultDiv = document.getElementById('gacha-result');
        const iconDiv = document.getElementById('gacha-result-icon');
        const nameDiv = document.getElementById('gacha-result-name');
        const rarityDiv = document.getElementById('gacha-result-rarity');

        iconDiv.innerText = item.icon;
        nameDiv.innerText = item.name;
        rarityDiv.innerHTML = `<span class="rarity-badge rarity-${item.rarity}">${item.rarity.toUpperCase()}</span> ${isNew ? '<span style="color:#00ff88;">‚ú® NEW!</span>' : '<span style="color:#999;">(Already Owned)</span>'}`;
        
        resultDiv.classList.add('active');
        resultDiv.className = `gacha-result active ${item.rarity}`;
        
        setTimeout(() => {
            resultDiv.classList.remove('active');
        }, 3000);
    }

    function updateCosmeticsList() {
        const cosmetics = storage.getCosmetics();
        const listDiv = document.getElementById('cosmetics-list');
        const equipped = storage.getEquippedCosmetics();

        if (cosmetics.length === 0) {
            listDiv.innerHTML = '<div style="text-align:center; color:#999; padding:20px; font-size:12px;">No cosmetics yet. Try the gacha!</div>';
            return;
        }

        const hats = cosmetics.filter(c => c.type === 'hat');
        const accessories = cosmetics.filter(c => c.type === 'accessory');

        let html = '';
        
        if (hats.length > 0) {
            html += '<div style="margin-bottom:15px;"><div style="font-size:11px; color:#999; margin-bottom:8px; text-transform:uppercase;">Hats</div>';
            hats.forEach(cosmetic => {
                const isEquipped = equipped.hat === cosmetic.id;
                html += `
                    <div class="cosmetic-item ${cosmetic.rarity}" style="${isEquipped ? 'border-color:var(--np-orange); background:rgba(255,107,0,0.1);' : ''}">
                        <div class="cosmetic-icon">${cosmetic.icon}</div>
                        <div class="cosmetic-info">
                            <div class="cosmetic-name">${cosmetic.name}</div>
                            <span class="rarity-badge rarity-${cosmetic.rarity}">${cosmetic.rarity.toUpperCase()}</span>
                        </div>
                        <button class="btn-action" style="padding:8px 15px; font-size:11px; width:auto; margin:0;" onclick="equipCosmetic('${cosmetic.id}', 'hat')">${isEquipped ? '‚úì Equipped' : 'Equip'}</button>
                    </div>
                `;
            });
            html += '</div>';
        }

        if (accessories.length > 0) {
            html += '<div><div style="font-size:11px; color:#999; margin-bottom:8px; text-transform:uppercase;">Accessories</div>';
            accessories.forEach(cosmetic => {
                const isEquipped = equipped.accessory === cosmetic.id;
                html += `
                    <div class="cosmetic-item ${cosmetic.rarity}" style="${isEquipped ? 'border-color:var(--np-orange); background:rgba(255,107,0,0.1);' : ''}">
                        <div class="cosmetic-icon">${cosmetic.icon}</div>
                        <div class="cosmetic-info">
                            <div class="cosmetic-name">${cosmetic.name}</div>
                            <span class="rarity-badge rarity-${cosmetic.rarity}">${cosmetic.rarity.toUpperCase()}</span>
                        </div>
                        <button class="btn-action" style="padding:8px 15px; font-size:11px; width:auto; margin:0;" onclick="equipCosmetic('${cosmetic.id}', 'accessory')">${isEquipped ? '‚úì Equipped' : 'Equip'}</button>
                    </div>
                `;
            });
            html += '</div>';
        }

        listDiv.innerHTML = html;
        updateCharacterPreview();
    }

    function showCosmeticPreview(type) {
        const previewDiv = document.getElementById('cosmetic-preview-list');
        const items = type === 'hats' ? cosmeticDatabase.hats : cosmeticDatabase.accessories;
        
        let html = '';
        items.forEach(item => {
            html += `
                <div class="cosmetic-item ${item.rarity}" style="margin-bottom:8px; padding:8px;">
                    <div class="cosmetic-icon" style="font-size:24px;">${item.icon}</div>
                    <div class="cosmetic-info">
                        <div class="cosmetic-name" style="font-size:12px;">${item.name}</div>
                        <span class="rarity-badge rarity-${item.rarity}">${item.rarity.toUpperCase()}</span>
                    </div>
                </div>
            `;
        });
        
        previewDiv.innerHTML = html;
    }

    function equipCosmetic(cosmeticId, slot) {
        storage.equipCosmetic(cosmeticId, slot);
        updateCosmeticsList();
        updateAllCharacterDisplays();
    }

    function updateCharacterPreview() {
        const charIcons = { leo: 'ü¶Å', sage: 'ü¶â', ollie: 'ü¶¶', felix: 'üê±', momo: 'üêí', sparky: 'üêøÔ∏è' };
        const currentIcon = charIcons[state.currentChar] || 'üë§';
        const equipped = storage.getEquippedCosmetics();
        const cosmetics = storage.getCosmetics();
        
        const hatCosmetic = cosmetics.find(c => c.id === equipped.hat);
        const accessoryCosmetic = cosmetics.find(c => c.id === equipped.accessory);
        
        let html = `<div style="position:relative; display:inline-block;">${currentIcon}`;
        
        if (hatCosmetic) {
            html += `<span class="equipped-cosmetic hat" style="font-size:24px;">${hatCosmetic.icon}</span>`;
        }
        
        if (accessoryCosmetic) {
            html += `<span class="equipped-cosmetic accessory" style="font-size:20px;">${accessoryCosmetic.icon}</span>`;
        }
        
        html += '</div>';
        
        document.getElementById('character-preview').innerHTML = html;
        
        let equippedText = [];
        if (hatCosmetic) equippedText.push(`Hat: ${hatCosmetic.name}`);
        if (accessoryCosmetic) equippedText.push(`Accessory: ${accessoryCosmetic.name}`);
        document.getElementById('equipped-cosmetics').innerText = 
            equippedText.length > 0 ? equippedText.join(' ‚Ä¢ ') : 'No cosmetics equipped';
    }

    function showPersonalityQuiz() {
        state.quizAnswers = [];
        const quizContainer = document.getElementById('personality-quiz');
        const resultDiv = document.getElementById('quiz-result');
        
        resultDiv.style.display = 'none';
        quizContainer.innerHTML = '';
        
        personalityQuiz.forEach((q, qIndex) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'quiz-question-container';
            questionDiv.innerHTML = `<h4>Q${qIndex + 1}. ${q.question}</h4>`;
            
            q.options.forEach((option, oIndex) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'quiz-option';
                optionDiv.innerHTML = `
                    <span class="quiz-option-icon">${option.icon}</span>
                    <span>${option.text}</span>
                `;
                optionDiv.onclick = () => selectQuizOption(qIndex, oIndex, option.value, optionDiv);
                questionDiv.appendChild(optionDiv);
            });
            
            quizContainer.appendChild(questionDiv);
        });
        
        navigate('screen-quiz-intro');
    }

    function selectQuizOption(questionIndex, optionIndex, value, element) {
        const questionContainer = element.parentElement;
        questionContainer.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected'));
        element.classList.add('selected');
        
        state.quizAnswers[questionIndex] = value;
        
        if (state.quizAnswers.filter(a => a).length === personalityQuiz.length) {
            setTimeout(() => showQuizResult(), 500);
        }
    }

 function showQuizResult() {
    const walkingCount = state.quizAnswers.filter(a => a === 'walking').length;
    const digitalCount = state.quizAnswers.filter(a => a === 'digital').length;
    
    const recommendedMode = walkingCount > digitalCount ? 'walking' : 'digital';
    state.recommendedMode = recommendedMode;
    storage.setRecommendedMode(recommendedMode);
    
    const resultDiv = document.getElementById('quiz-result');
    const iconDiv = document.getElementById('result-icon');
    const titleDiv = document.getElementById('result-title');
    const descDiv = document.getElementById('result-desc');
    
    if (recommendedMode === 'walking') {
        iconDiv.innerText = 'üö∂‚Äç‚ôÇÔ∏è';
        titleDiv.innerText = 'WALKING TRAIL EXPLORER';
        descDiv.innerHTML = `
            You learn best through hands-on exploration! Walking trails will let you discover NP's heritage by physically visiting historical locations around campus.
            <div style="margin-top:20px; padding:15px; background:rgba(255,107,0,0.1); border:1px solid var(--np-orange); border-radius:12px;">
                <div style="font-size:12px; color:#ffaa00; margin-bottom:12px; font-weight:800; text-transform:uppercase;">üìç Your Recommended Journey:</div>
                <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
                    <div style="background:rgba(0,0,0,0.3); padding:8px 12px; border-radius:8px; font-size:20px;">
                        ü¶Å <span style="font-size:11px; vertical-align:middle; margin-left:4px;">Leo</span>
                    </div>
                    <div style="color:#666; font-size:16px; display:flex; align-items:center;">‚Üí</div>
                    <div style="background:rgba(0,0,0,0.3); padding:8px 12px; border-radius:8px; font-size:20px;">
                        ü¶¶ <span style="font-size:11px; vertical-align:middle; margin-left:4px;">Ollie</span>
                    </div>
                    <div style="color:#666; font-size:16px; display:flex; align-items:center;">‚Üí</div>
                    <div style="background:rgba(0,0,0,0.3); padding:8px 12px; border-radius:8px; font-size:20px;">
                        üêí <span style="font-size:11px; vertical-align:middle; margin-left:4px;">Momo</span>
                    </div>
                </div>
                <div style="font-size:10px; color:#999; margin-top:10px; text-align:center;">Complete all three to unlock digital trails!</div>
            </div>
        `;
    } else {
        iconDiv.innerText = 'üíª';
        titleDiv.innerText = 'DIGITAL TRAIL NAVIGATOR';
        descDiv.innerHTML = `
            You prefer immersive digital experiences! Digital trails offer rich multimedia content including videos and interactive elements to explore NP's history.
            <div style="margin-top:20px; padding:15px; background:rgba(255,107,0,0.1); border:1px solid var(--np-orange); border-radius:12px;">
                <div style="font-size:12px; color:#ffaa00; margin-bottom:12px; font-weight:800; text-transform:uppercase;">üíª Your Recommended Journey:</div>
                <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
                    <div style="background:rgba(0,0,0,0.3); padding:8px 12px; border-radius:8px; font-size:20px;">
                        ü¶â <span style="font-size:11px; vertical-align:middle; margin-left:4px;">Sage</span>
                    </div>
                    <div style="color:#666; font-size:16px; display:flex; align-items:center;">‚Üí</div>
                    <div style="background:rgba(0,0,0,0.3); padding:8px 12px; border-radius:8px; font-size:20px;">
                        üê± <span style="font-size:11px; vertical-align:middle; margin-left:4px;">Felix</span>
                    </div>
                    <div style="color:#666; font-size:16px; display:flex; align-items:center;">‚Üí</div>
                    <div style="background:rgba(0,0,0,0.3); padding:8px 12px; border-radius:8px; font-size:20px;">
                        üêøÔ∏è <span style="font-size:11px; vertical-align:middle; margin-left:4px;">Sparky</span>
                    </div>
                </div>
                <div style="font-size:10px; color:#999; margin-top:10px; text-align:center;">Complete all three to unlock walking trails!</div>
            </div>
        `;
    }
      resultDiv.style.display = 'block';
    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
}

    function updateCharacterLocks() {
        const hasCompleted = storage.hasCompletedRecommendedTrail();
        const recommendedMode = storage.getRecommendedMode();
        
        const messageDiv = document.getElementById('trail-unlock-message');
        
        if (!hasCompleted && recommendedMode) {
            messageDiv.style.display = 'block';
        } else {
            messageDiv.style.display = 'none';
        }
        
        document.querySelectorAll('.char-card').forEach(card => {
            const cardMode = card.dataset.mode;
            const lockOverlay = card.querySelector('.lock-overlay');
            
            if (!hasCompleted && recommendedMode && cardMode !== recommendedMode) {
                card.classList.add('locked');
                if (lockOverlay) lockOverlay.style.display = 'flex';
            } else {
                card.classList.remove('locked');
                if (lockOverlay) lockOverlay.style.display = 'none';
            }
        });
    }

    function showLoginForm() {
        document.getElementById('login-form').style.display = 'block';
        document.getElementById('register-form').style.display = 'none';
        document.getElementById('login-message').style.display = 'none';
    }

    function showRegisterForm() {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('register-form').style.display = 'block';
        document.getElementById('login-message').style.display = 'none';
    }

    function handleLogin() {
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value.trim();
        const messageDiv = document.getElementById('login-message');
        
        if (!username || !password) {
            messageDiv.style.display = 'block';
            messageDiv.style.color = '#ff4444';
            messageDiv.innerText = '‚ö†Ô∏è Please fill in all fields';
            return;
        }
        
        const account = storage.validateLogin(username, password);
        if (!account) {
            messageDiv.style.display = 'block';
            messageDiv.style.color = '#ff4444';
            messageDiv.innerText = '‚ùå Invalid username or password';
            return;
        }
        
        state.userName = username;
        state.accountData = account;
        messageDiv.style.display = 'block';
        messageDiv.style.color = '#00ff88';
        messageDiv.innerText = `Welcome back, ${username}! Your streak: ${account.streak || 0} days`;
        
        setTimeout(() => {
            navigate('screen-daily');
            updateDailyDashboard();
            updateCoinDisplay();
        }, 800);
    }

    function handleRegister() {
        const username = document.getElementById('register-username').value.trim();
        const password = document.getElementById('register-password').value.trim();
        const confirm = document.getElementById('register-confirm').value.trim();
        const messageDiv = document.getElementById('login-message');
        
        if (!username || !password || !confirm) {
            messageDiv.style.display = 'block';
            messageDiv.style.color = '#ff4444';
            messageDiv.innerText = '‚ö†Ô∏è Please fill in all fields';
            return;
        }
        
        if (password !== confirm) {
            messageDiv.style.display = 'block';
            messageDiv.style.color = '#ff4444';
            messageDiv.innerText = '‚ùå Passwords do not match';
            return;
        }
        
        if (password.length < 4) {
            messageDiv.style.display = 'block';
            messageDiv.style.color = '#ff4444';
            messageDiv.innerText = '‚ùå Password must be at least 4 characters';
            return;
        }
        
        if (!storage.createAccount(username, password)) {
            messageDiv.style.display = 'block';
            messageDiv.style.color = '#ff4444';
            messageDiv.innerText = '‚ùå Username already exists';
            return;
        }
        
        messageDiv.style.display = 'block';
        messageDiv.style.color = '#00ff88';
        messageDiv.innerText = '‚úÖ Account created! You can now login.';
        
        setTimeout(() => {
            showLoginForm();
            document.getElementById('login-username').value = username;
            document.getElementById('register-username').value = '';
            document.getElementById('register-password').value = '';
            document.getElementById('register-confirm').value = '';
        }, 1500);
    }

    function updateDailyDashboard() {
        const account = storage.getAccountData(state.userName);
        if (!account) return;
        
        document.getElementById('streak-count').innerText = account.streak || 0;
        document.getElementById('total-logins').innerText = account.totalLogins || 1;
        document.querySelector('#screen-daily .card h2').innerText = `Daily Dashboard, ${state.userName}`;
        
        const task = storage.getDailyTask();
        const today = new Date().toDateString();
        const taskCompleted = account.lastTaskDate === today;
        
        const taskContent = document.getElementById('daily-task-content');
        if (taskCompleted) {
            taskContent.innerHTML = `<div style="text-align:center; padding:20px;"><div style="font-size:40px; margin-bottom:10px;">‚úÖ</div><div style="color:#00ff88; font-weight:800;">Task Completed, ${state.userName}!</div><div style="color:#999; font-size:11px; margin-top:5px;">Come back tomorrow</div></div>`;
        } else if (task.type === 'trivia') {
            taskContent.innerHTML = `
                <div style="margin-bottom:10px; font-weight:600; font-size:13px;">${task.question}</div>
                <div id="task-options"></div>
                <div style="text-align:center; margin-top:10px; color:var(--np-orange); font-weight:800; font-size:12px;">üéÅ Reward: ${task.reward} pts + ${Math.floor(task.reward/10)} ü™ô</div>
            `;
            const optionsDiv = document.getElementById('task-options');
            task.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.style.padding = '10px';
                btn.style.fontSize = '12px';
                btn.innerText = opt;
                btn.onclick = () => checkDailyTask(opt, task.answer, task.reward, btn);
                optionsDiv.appendChild(btn);
            });
        }
        
        updateHeaderScore();
        updateCoinDisplay();
    }

    function checkDailyTask(choice, answer, reward, button) {
        if (choice === answer) {
            button.classList.add('correct');
            document.querySelectorAll('#task-options .option-btn').forEach(btn => btn.disabled = true);
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            if (!state.isMuted) audio.sfx.play().catch(e => console.log('SFX play failed:', e));
            
            if (storage.completeDailyTask('daily')) {
                const data = storage.getUserData();
                data.dailyTaskBonus = (data.dailyTaskBonus || 0) + reward;
                const coinsEarned = Math.floor(reward / 10);
                if (coinsEarned > 0) {
                    storage.addCoins(coinsEarned);
                }
                storage.saveUserData(data);
                updateHeaderScore();
                updateCoinDisplay();
                
                setTimeout(() => {
                    updateDailyDashboard();
                }, 1200);
            }
        } else {
            button.classList.add('wrong');
            button.disabled = true;
        }
    }

    function enterApp() {
        updateAllCharacterDisplays();
        
        const recommendedMode = storage.getRecommendedMode();
        if (!recommendedMode) {
            showPersonalityQuiz();
        } else {
            updateCharacterLocks();
            navigate('screen-character');
        }
    }

    function selectChar(name, icon, mode) {
        const hasCompleted = storage.hasCompletedRecommendedTrail();
        const recommendedMode = storage.getRecommendedMode();
        
        if (!hasCompleted && recommendedMode && mode !== recommendedMode) {
            alert('üîí Complete your recommended trail first to unlock other trails!');
            return;
        }
        
        const equipped = storage.getEquippedCosmetics();
        const cosmetics = storage.getCosmetics();
        
        let characterDisplay = icon;
        const hatCosmetic = cosmetics.find(c => c.id === equipped.hat);
        const accessoryCosmetic = cosmetics.find(c => c.id === equipped.accessory);
        
        if (hatCosmetic || accessoryCosmetic) {
            characterDisplay = '';
            if (hatCosmetic) characterDisplay += hatCosmetic.icon;
            characterDisplay += icon;
            if (accessoryCosmetic) characterDisplay += accessoryCosmetic.icon;
        }
        
        document.getElementById('walking-char').innerText = characterDisplay;
        state.currentMode = mode;
        state.currentChar = name;
        state.currentStage = 0;
        audio.bgm.play().catch(e => console.log('Audio autoplay prevented:', e));
        updateHeaderScore();
        updateCoinDisplay();
        updateCharacterDisplay();
        showClue();
    }

    function updateCharacterDisplay() {
        const charIcons = { leo: 'ü¶Å', sage: 'ü¶â', ollie: 'ü¶¶', felix: 'üê±', momo: 'üêí', sparky: 'üêøÔ∏è' };
        const icon = charIcons[state.currentChar];
        if (!icon) return;
        
        const equipped = storage.getEquippedCosmetics();
        const cosmetics = storage.getCosmetics();
        const hatCosmetic = cosmetics.find(c => c.id === equipped.hat);
        const accessoryCosmetic = cosmetics.find(c => c.id === equipped.accessory);
        
        let characterDisplay = icon;
        if (hatCosmetic || accessoryCosmetic) {
            characterDisplay = '';
            if (hatCosmetic) characterDisplay += hatCosmetic.icon;
            characterDisplay += icon;
            if (accessoryCosmetic) characterDisplay += accessoryCosmetic.icon;
        }
        
        const walkingChar = document.getElementById('walking-char');
        if (walkingChar) walkingChar.innerText = characterDisplay;
    }

    function updateAllCharacterDisplays() {
        const charIcons = { leo: 'ü¶Å', sage: 'ü¶â', ollie: 'ü¶¶', felix: 'üê±', momo: 'üêí', sparky: 'üêøÔ∏è' };
        const equipped = storage.getEquippedCosmetics();
        const cosmetics = storage.getCosmetics();
        const hatCosmetic = cosmetics.find(c => c.id === equipped.hat);
        
        Object.keys(charIcons).forEach(charName => {
            const displayElement = document.getElementById(`char-display-${charName}`);
            if (displayElement) {
                let charDisplay = charIcons[charName];
                if (hatCosmetic) {
                    charDisplay = hatCosmetic.icon + charIcons[charName];
                }
                displayElement.innerText = charDisplay;
            }
        });
    }

    function startOppositeMode() {
        const hasCompleted = storage.hasCompletedRecommendedTrail();
        const recommendedMode = storage.getRecommendedMode();
        const oppositeMode = state.currentMode === 'walking' ? 'digital' : 'walking';
        
        if (!hasCompleted && recommendedMode && oppositeMode !== recommendedMode) {
            alert('üîí Complete your recommended trail first to unlock other trails!');
            return;
        }
        
        const counterparts = { leo: 'sage', sage: 'leo', ollie: 'felix', felix: 'ollie', momo: 'sparky', sparky: 'momo' };
        const newChar = counterparts[state.currentChar];
        state.currentChar = newChar;
        state.currentMode = oppositeMode;
        state.currentStage = 0;
        updateCharacterDisplay();
        showClue();
    }

    function showClue() {
        document.getElementById('map-bar').classList.remove('hidden');
        const data = storyData[state.currentChar][state.currentStage];
        
        if (!data) return;

        document.getElementById('clue-title').innerText = data.title;
        const mediaBox = document.getElementById('clue-media');
        const locationBox = document.getElementById('location-hint');

        mediaBox.innerHTML = '';
        mediaBox.style.display = "none";

        if (state.currentMode === 'walking') {
            locationBox.style.display = "block";
            document.getElementById('location-text').innerText = data.loc;
            
            if (data.image) {
                mediaBox.innerHTML = `<img src="${data.image}" alt="Clue Image" style="width:100%; height:100%; object-fit:cover;">`;
                mediaBox.style.display = "block";
            }
        } else {
            locationBox.style.display = "none";
            
            if (data.media) {
                mediaBox.innerHTML = data.media;
                mediaBox.style.display = "block";
            } else if (data.image) {
                mediaBox.innerHTML = `<img src="${data.image}" alt="Clue Image" style="width:100%; height:100%; object-fit:cover;">`;
                mediaBox.style.display = "block";
            }
        }
        document.getElementById('clue-quote').innerText = `${data.icon} ${data.exp}: "${data.fact}"`;
        updateNodes();
        navigate('screen-clue');
    }

    function showQuiz() {
        state.attemptsLeft = 3;
        state.quizAnswered = false;
        updateAttempts();
        const data = storyData[state.currentChar][state.currentStage];
        const quizDiv = document.getElementById('quiz-question');
        quizDiv.innerHTML = '';

        if (data.image) {
            const img = document.createElement('img');
            img.src = data.image;
            img.style.cssText = `
                width: 100%; 
                height: 150px; 
                object-fit: cover; 
                border-radius: 12px; 
                margin-bottom: 10px; 
                display: block;
                border: 1px solid #00d4ff;
            `;
            quizDiv.appendChild(img);
        }
        quizDiv.innerHTML += `<br><strong>${data.question}</strong>`;

        const optionsContainer = document.getElementById('quiz-options');
        optionsContainer.innerHTML = "";
        data.options.forEach(option => {
            const button = document.createElement('button');
            button.className = "option-btn";
            button.innerText = option;
            button.onclick = () => checkAnswer(option, button, data.answer);
            optionsContainer.appendChild(button);
        });
        navigate('screen-quiz');
    }

    function checkAnswer(choice, button, correctAnswer) {
        if (state.quizAnswered) return;
        if (choice === correctAnswer) {
            state.quizAnswered = true;
            button.classList.add('correct');
            document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
            confetti({ particleCount: 80, spread: 70, origin: { y: 0.6 } });
            if (!state.isMuted) audio.sfx.play().catch(e => console.log('SFX play failed:', e));
            const baseScore = state.currentMode === 'walking' ? 100 : 50;
            let points;
            if (state.attemptsLeft === 3) points = baseScore;
            else if (state.attemptsLeft === 2) points = Math.floor(baseScore / 2);
            else points = Math.floor(baseScore / 4);
            storage.saveScore(points);
            updateHeaderScore();
            updateCoinDisplay();
            setTimeout(runTransition, 1200);
        } else {
            button.classList.add('wrong');
            button.disabled = true;
            state.attemptsLeft--;
            updateAttempts();
            if (state.attemptsLeft <= 0) {
                state.quizAnswered = true;
                document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
                setTimeout(runTransition, 1500);
            }
        }
    }

    function runTransition() {
        const overlay = document.getElementById('transition-overlay');
        overlay.classList.add('active');
        setTimeout(() => {
            overlay.classList.remove('active');
            const totalStages = storyData[state.currentChar].length;
            if (state.currentStage < totalStages - 1) {
                state.currentStage++;
                showClue();
            } else {
                finishGame();
            }
        }, 2500);
    }

    function updateLeaderboard() {
    const leaderboardList = document.getElementById('leaderboard-list');
    const users = storage.getAllUsers();
    if (users.length === 0) {
        leaderboardList.innerHTML = '<div style="text-align:center; color:#888; padding:20px; font-size:12px;">No players yet. Be the first!</div>';
        return;
    }
    const top10 = users.slice(0, 10);
    leaderboardList.innerHTML = top10.map((user, index) => {
        const rank = index + 1;
        let medal = '';
        if (rank === 1) medal = '<span class="medal">ü•á</span>';
        else if (rank === 2) medal = '<span class="medal">ü•à</span>';
        else if (rank === 3) medal = '<span class="medal">ü•â</span>';
        const isCurrentUser = user.name.toLowerCase() === state.userName.toLowerCase();
        const highlightClass = isCurrentUser ? 'current-user' : '';
       return `<div class="list-item ${highlightClass}"><span class="rank">${medal || rank}</span><span class="name">${user.name}${isCurrentUser ? ' (You)' : ''}</span><span class="score">${user.total} pts</span></div>`;
    }).join('');
    }
    function updateHeaderScore() {
        const data = storage.getUserData();
        let total = 0;
        
        // Calculate total from all characters
        Object.keys(data).forEach(charKey => {
            if (typeof data[charKey] === 'object' && charKey !== 'dailyTaskBonus' && charKey !== 'cosmetics' && charKey !== 'equippedCosmetics') {
                Object.values(data[charKey]).forEach(score => total += score);
            }
        });
        
        // Add daily task bonus
        total += (data.dailyTaskBonus || 0);
        
        document.getElementById('header-score').innerText = `PTS: ${total}`;
    }

    function updateAttempts() {
        const attemptsDisplay = document.getElementById('attempts-display');
        if (attemptsDisplay) {
            const hearts = '‚ù§Ô∏è'.repeat(state.attemptsLeft) + 'üñ§'.repeat(3 - state.attemptsLeft);
            attemptsDisplay.innerText = `Attempts: ${hearts}`;
        }
    }

    function updateNodes() {
        for (let i = 0; i < 3; i++) {
            const node = document.getElementById(`n${i}`);
            if (node) {
                node.classList.remove('active', 'done');
                if (i < state.currentStage) {
                    node.classList.add('done');
                } else if (i === state.currentStage) {
                    node.classList.add('active');
                }
            }
        }
    }

    function finishGame() {
        const data = storage.getUserData();
        
        // Calculate scores by mode
        let walkingTotal = 0;
        let digitalTotal = 0;
        
        const walkingChars = ['leo', 'ollie', 'momo'];
        const digitalChars = ['sage', 'felix', 'sparky'];
        
        walkingChars.forEach(char => {
            if (data[char]) {
                Object.values(data[char]).forEach(score => walkingTotal += score);
            }
        });
        
        digitalChars.forEach(char => {
            if (data[char]) {
                Object.values(data[char]).forEach(score => digitalTotal += score);
            }
        });
        
        const dailyBonus = data.dailyTaskBonus || 0;
        const grandTotal = walkingTotal + digitalTotal + dailyBonus;
        
        // Update result display
        document.getElementById('res-walking').innerText = walkingTotal;
        document.getElementById('res-digital').innerText = digitalTotal;
        document.getElementById('res-daily').innerText = dailyBonus;
        document.getElementById('res-total').innerText = grandTotal + ' pts';
        
        // Update switch button
        const switchBtn = document.getElementById('switch-btn');
        const oppositeMode = state.currentMode === 'walking' ? 'digital' : 'walking';
        const oppositeModeText = oppositeMode === 'walking' ? 'Walking' : 'Digital';
        switchBtn.innerText = `Try ${oppositeModeText} Trail`;
        
        // Update leaderboard
        updateLeaderboard();
        
        // Navigate to finish screen
        navigate('screen-finish');
    }

    function submitFeedback() {
        const feedbackText = document.getElementById('feedback-text').value.trim();
        const statusDiv = document.getElementById('feedback-status');
        
        if (!feedbackText) {
            statusDiv.style.display = 'block';
            statusDiv.style.color = '#ff4444';
            statusDiv.innerText = '‚ö†Ô∏è Please write something first!';
            return;
        }
        
        // Save feedback to localStorage
        const feedbackKey = 'np_feedback_list';
        let feedbackList = [];
        
        try {
            const existing = localStorage.getItem(feedbackKey);
            if (existing) feedbackList = JSON.parse(existing);
        } catch (e) {
            console.error('Error reading feedback:', e);
        }
        
        feedbackList.push({
            user: state.userName,
            text: feedbackText,
            date: new Date().toISOString()
        });
        
        localStorage.setItem(feedbackKey, JSON.stringify(feedbackList));
        
        // Show success message
        statusDiv.style.display = 'block';
        statusDiv.style.color = '#00ff88';
        statusDiv.innerText = '‚úÖ Feedback submitted! Thank you!';
        
        // Clear textarea
        document.getElementById('feedback-text').value = '';
        
        // Hide message after 3 seconds
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 3000);
    }

    function viewFeedback() {
        const feedbackKey = 'np_feedback_list';
        let feedbackList = [];
        
        try {
            const existing = localStorage.getItem(feedbackKey);
            if (existing) feedbackList = JSON.parse(existing);
        } catch (e) {
            console.error('Error reading feedback:', e);
        }
        
        const feedbackListDiv = document.getElementById('feedback-list');
        
        if (feedbackList.length === 0) {
            feedbackListDiv.innerHTML = '<div style="text-align:center; color:#888; padding:40px; font-size:13px;">No feedback yet. Be the first to share!</div>';
        } else {
            // Sort by date, newest first
            feedbackList.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = '';
            feedbackList.forEach(item => {
                const date = new Date(item.date);
                const dateStr = date.toLocaleDateString('en-SG', { month: 'short', day: 'numeric', year: 'numeric' });
                
                html += `
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:15px; margin-bottom:12px; border-left:3px solid var(--np-orange);">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <span style="font-weight:800; color:var(--np-orange); font-size:13px;">${item.user}</span>
                            <span style="font-size:10px; color:#999;">${dateStr}</span>
                        </div>
                        <p style="margin:0; font-size:12px; color:#ddd; line-height:1.5;">${item.text}</p>
                    </div>
                `;
            });
            
            feedbackListDiv.innerHTML = html;
        }
        
        navigate('screen-feedback');
    }
    window.equipCosmetic = equipCosmetic;

</script> 
</body>
</html>
